<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directed Graph Visualization</title>
    <style>
       
        .node {
            fill: #66b3ff;
            stroke: #0074d9;
            stroke-width: 2px;
        }

        .arrow-line {
            stroke: grey;
            stroke-width: 1;
        }

        .arrow-head {
            fill: blue;
            width: 2;
        }

        .node-text {
            font-size: 12px;
            text-anchor: middle;
            dominant-baseline: central;
        }
    </style>
</head>
<body>
    <svg id="graph-container" width="1200" height="800">
        <defs>
            <marker
                id="arrow"
                markerUnits="strokeWidth"
                markerWidth="12"
                markerHeight="12"
                viewBox="0 0 12 12"
                refX="6"
                refY="6"
                orient="auto">
                <path d="M2,2 L10,6 L2,10 L6,6 L2,2" class="arrow-head"></path>
            </marker>
        </defs>
    </svg>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
       
        let graphData = {};
        

        fetch('/graph_data')
            .then(response => response.json())
            .then(data => {
                graphData = data;

            
                const svg = d3.select("#graph-container"),
                    width = +svg.attr("width"),
                    height = +svg.attr("height");

                const nodes = [];
                const links = [];

           
                Object.keys(graphData).forEach(sourceId => {
       
                    if (!nodes.find(node => node.id === parseInt(sourceId))) {
                        nodes.push({ id: parseInt(sourceId) });
                    }

                    graphData[sourceId].forEach(targetId => {
   
                        if (!nodes.find(node => node.id === targetId)) {
                            nodes.push({ id: targetId });
                        }


                        links.push({ source: parseInt(sourceId), target: targetId });
                    });
                });


                const simulation = d3.forceSimulation(nodes)
                    .force("link", d3.forceLink(links).id(d => d.id).distance(100))
                    .force("charge", d3.forceManyBody().strength(-500))
                    .force("center", d3.forceCenter(width / 2, height / 2));

                const link = svg.append("g")
                    .attr("class", "links")
                    .selectAll("g")
                    .data(links)
                    .enter().append("g")
                    .attr("class", "link");
                
                
                link.append("line")
                    .attr("class", "arrow-line")
                    .attr("stroke", "red")
                    .attr("stroke-width", 1);

                link.append("path")
                    .attr("class", "arrow-head")
                    .attr("marker-end", "url(#arrow)")
                    .style("fill", "red");
                

                // var line = svg.append("line")
                //     .attr("x1",)  
                //     .attr("y1",10)  
                //     .attr("x2",200)  
                //     .attr("y2",50)  
                //     .attr("stroke","red")  
                //     .attr("stroke-width",2)  
                //     .attr("marker-end","url(#arrow)");


                
                const node = svg.append("g")
                    .attr("class", "nodes")
                    .selectAll("circle")
                    .data(nodes)
                    .enter().append("circle")
                    .attr("class", "node")
                    .attr("r", 10);


                const nodeText = svg.append("g")
                    .attr("class", "node-labels")
                    .selectAll("text")
                    .data(nodes)
                    .enter().append("text")
                    .attr("class", "node-text")
                    .text(d => d.id);

                node.append("title")
                    .text(d => d.id);

                simulation.on("tick", () => {
                    link.select(".arrow-line")
                        .attr("stroke", "red")
                        .attr("stroke-width", 1)
                        .attr("marker-end", "url(#arrow)");

                    link.select(".arrow-line")
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => {
                            const distance = Math.sqrt((d.target.x - d.source.x) ** 2 + (d.target.y - d.source.y) ** 2);
                            return d.source.x + ((distance - 15) / distance) * (d.target.x - d.source.x);
                        })
                        .attr("y2", d => {
                            const distance = Math.sqrt((d.target.x - d.source.x) ** 2 + (d.target.y - d.source.y) ** 2);
                            return d.source.y + ((distance - 15) / distance) * (d.target.y - d.source.y);
                        });

                    link.select(".arrow-head")
                        .attr("transform", function (d) {
                            const dx = d.target.x - d.source.x;
                            const dy = (d.target.y - d.source.y);
                            const angle = Math.atan2(dy, dx); 
                            const length = 20; 

 
                            const midX = (d.source.x + d.target.x) / 2;
                            const midY = (d.source.y + d.target.y) / 2;

    
                            return `translate(${midX},${midY}) rotate(${angle * (180 / Math.PI)}, 0, 0) translate(${length},0)`;
                        });
                         

                    node
                        .attr("cx", d => d.x)
                        .attr("cy", d => d.y);

  
                    nodeText
                        .attr("x", d => d.x)
                        .attr("y", d => d.y);
                });

            })
            .catch(error => console.error('Error fetching data:', error));
    </script>
</body>
</html>
